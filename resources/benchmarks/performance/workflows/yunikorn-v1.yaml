name: yunikorn-performance-benchmark-v1
description: |
  Performance benchmark for YuniKorn with a large number of identical, independent jobs.
  This tests the scheduler's throughput and efficiency when handling many small jobs.
tasks:
  # Configure nodes
  - id: configure
    type: Configure
    params:
      nodes:
        - type: hpc.gpu
          count: 700
          labels:
            nvidia.com/gpu.count: "8"
            nvidia.com/mlnxnics: "16"
            nvidia.com/gpu.product: NVIDIA-A100-SXM4-80GB
          resources:
            cpu: 128
            memory: "1Ti"
            pods: 110
            nvidia.com/gpu: 8
            nvidia.com/mlnxnics: 16
            hugepages-1Gi: 0
            hugepages-2Mi: 0
            ephemeral-storage: "30Ti"
      timeout: 5m

  # Configure YuniKorn
  - id: configure-yunikorn
    type: Configure
    params:
      configmaps:
        - name: yunikorn-configs
          namespace: yunikorn
          op: create
          data:
            queues.yaml: |
              partitions:
                - name: default
                  queues:
                  - name: root
                    queues:
                    - name: perf-benchmark
                      submitacl: '*'
                      resources:
                        guaranteed:
                          memory: 10Gi
                          vcore: 10000m
                          nvidia.com/gpu: 100
                        max:
                          memory: 700Ti
                          vcore: 89600000m     # 128 cores × 700 nodes
                          nvidia.com/gpu: 5600 # 8 GPUs × 700 nodes
            # Performance-optimized settings
            yunikorn-defaults.yaml: |
              serviceCacheMaxJitter: 0
              batchMaxJitterPercent: 0
              enableForcefulNodeRemoval: true
              cacheMetricsEnabled: true
      deploymentRestarts:
        - namespace: yunikorn
          name: yunikorn-scheduler
      timeout: 5m

  # Register job template
  - id: register-job
    type: RegisterObj
    params:
      template: "resources/benchmarks/performance/templates/yunikorn/job.yaml"
      nameFormat: "perftest-v1-job{{._ENUM_}}"
      podNameFormat: "{{._NAME_}}-.*"
      podCount: "{{.parallelism}}"

  # Submit 700 separate jobs, each creating 1 pod
  # CPU = 700 jobs × 16 cores (16000m) = 11,200 cores total (12.5% z 89,600)
  # Memory = 700 jobs × 256Gi = 179,200Gi = ~175Ti total (25% z 700Ti)
  # GPU = 700 jobs × 4 GPU = 2,800 GPUs total (50% z 5,600)
  - id: job
    type: SubmitObj
    params:
      refTaskId: register-job
      count: 700
      params:
        namespace: default
        completions: 1
        parallelism: 1
        applicationId: "perf-v1"
        queue: "root.perf-benchmark"
        image: ubuntu
        cpu: 16000m # 16 cores (12.5% of node)
        memory: 256Gi # 256GB (25% of node)
        gpu: 4 # 4 GPUs (50% of node)
        ttl: 5m
