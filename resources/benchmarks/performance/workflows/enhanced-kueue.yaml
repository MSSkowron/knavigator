# Copyright (c) 2024, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: enhanced-kueue-benchmark
description: |
  A comprehensive performance benchmark for Kueue scheduler testing that:
  1. Collects baseline metrics before testing
  2. Performs incremental scaling tests to identify performance limits
  3. Measures key performance indicators like throughput and scheduling latency
  4. Tests resource utilization efficiency under varied conditions
tasks:
# Register Kueue-specific resources
- id: register-cluster-queue
  type: RegisterObj
  params:
    template: "resources/templates/kueue/cluster-queue.yaml"
- id: register-local-queue
  type: RegisterObj
  params:
    template: "resources/templates/kueue/local-queue.yaml"
- id: register-resource-flavor
  type: RegisterObj
  params:
    template: "resources/templates/kueue/resource-flavor.yaml"
- id: register-job
  type: RegisterObj
  params:
    template: "resources/templates/kueue/job.yaml"
    nameFormat: "perftest-job{{._ENUM_}}"
    podNameFormat: "{{._NAME_}}-[0-9]-.*"
    podCount: "{{.parallelism}}"
- id: register-configmap
  type: RegisterObj
  params:
    template: "resources/templates/k8s/configmap.yaml"

# Configure nodes and Kueue settings
- id: configure
  type: Configure
  params:
    nodes:
    - type: dgxa100.80g
      count: 700
      labels:
        nvidia.com/gpu.count: "8"
    namespaces:
    - name: perf-benchmark
      op: create
    configmaps:
    - name: benchmark-metrics
      namespace: perf-benchmark
      op: create
      data:
        start_time: ""
        test_phase: "setup"
        pods_scheduled: "0"
        pods_pending: "0"
        scheduler_cpu_usage: "0"
        scheduler_memory_usage: "0"
    - name: kueue-manager-config
      namespace: kueue-system
      op: create
      data:
        controller_manager_config.yaml: |
          apiVersion: config.kueue.x-k8s.io/v1beta1
          kind: Configuration
          health:
            healthProbeBindAddress: :8081
          metrics:
            bindAddress: :8080
          webhook:
            port: 9443
          leaderElection:
            leaderElect: true
            resourceName: c1f6bfd2.kueue.x-k8s.io
          controller:
            groupKindConcurrency:
              Job.batch: 5
              Pod: 5
              Workload.kueue.x-k8s.io: 5
              LocalQueue.kueue.x-k8s.io: 1
              ClusterQueue.kueue.x-k8s.io: 1
              ResourceFlavor.kueue.x-k8s.io: 1
          clientConnection:
            qps: 50
            burst: 100
          waitForPodsReady:
            enable: true
            timeout: 5m
            blockAdmission: true
            requeuingStrategy:
              timestamp: Eviction
              backoffLimitCount: null
              backoffBaseSeconds: 60
              backoffMaxSeconds: 3600
          integrations:
            frameworks:
            - "batch/job"
    deploymentRestarts:
    - namespace: kueue-system
      name: kueue-controller-manager
    timeout: 5m

# Create ResourceFlavor, ClusterQueue, LocalQueue
- id: create-resource-flavor
  type: SubmitObj
  params:
    refTaskId: register-resource-flavor
    canExist: true
    params:
      name: "gpu-node"
      nodeLabels:
        nvidia.com/gpu.count: "8"
- id: create-cluster-queue
  type: SubmitObj
  params:
    refTaskId: register-cluster-queue
    canExist: true
    params:
      name: team
      flavor: gpu-node
      cpu: 70000m
      memory: 700Gi
      pods: 700
      gpu: 5600
- id: create-local-queue
  type: SubmitObj
  params:
    refTaskId: register-local-queue
    canExist: true
    params:
      name: team-queue
      namespace: perf-benchmark
      clusterQueue: team

# Record baseline metrics
- id: update-test-phase-baseline
  type: UpdateObj
  params:
    refTaskId: register-configmap
    state:
      data:
        test_phase: "baseline"
        start_time: "{{now}}"
    timeout: 5s

# Small scale test - 50 pods
- id: update-test-phase-small
  type: UpdateObj
  params:
    refTaskId: register-configmap
    state:
      data:
        test_phase: "small_scale"
        start_time: "{{now}}"
    timeout: 5s

- id: small-scale-test
  type: SubmitObj
  params:
    refTaskId: register-job
    count: 50
    params:
      namespace: perf-benchmark
      parallelism: 1
      completions: 1
      queueName: team-queue
      image: ubuntu
      cpu: 100m
      memory: 128Mi
      gpu: 1
      ttl: "30s"

- id: small-scale-wait
  type: CheckPod
  params:
    refTaskId: small-scale-test
    status: Running
    timeout: 2m

- id: update-small-scale-metrics
  type: UpdateObj
  params:
    refTaskId: register-configmap
    state:
      data:
        small_scale_completion_time: "{{now}}"
        small_scale_status: "completed"
    timeout: 5s

# Medium scale test - 200 pods
- id: update-test-phase-medium
  type: UpdateObj
  params:
    refTaskId: register-configmap
    state:
      data:
        test_phase: "medium_scale"
        start_time: "{{now}}"
    timeout: 5s

- id: medium-scale-test
  type: SubmitObj
  params:
    refTaskId: register-job
    count: 4
    params:
      namespace: perf-benchmark
      parallelism: 50
      completions: 50
      queueName: team-queue
      image: ubuntu
      cpu: 100m
      memory: 128Mi
      gpu: 1
      ttl: "30s"

- id: medium-scale-wait
  type: CheckPod
  params:
    refTaskId: medium-scale-test
    status: Running
    timeout: 5m

- id: update-medium-scale-metrics
  type: UpdateObj
  params:
    refTaskId: register-configmap
    state:
      data:
        medium_scale_completion_time: "{{now}}"
        medium_scale_status: "completed"
    timeout: 5s

# Large scale test - 700 pods
- id: update-test-phase-large
  type: UpdateObj
  params:
    refTaskId: register-configmap
    state:
      data:
        test_phase: "large_scale"
        start_time: "{{now}}"
    timeout: 5s

- id: large-scale-test
  type: SubmitObj
  params:
    refTaskId: register-job
    count: 1
    params:
      namespace: perf-benchmark
      parallelism: 700
      completions: 700
      queueName: team-queue
      image: ubuntu
      cpu: 100m
      memory: 128Mi
      gpu: 1
      ttl: "60s"

- id: large-scale-wait
  type: CheckPod
  params:
    refTaskId: large-scale-test
    status: Running
    timeout: 10m

- id: update-large-scale-metrics
  type: UpdateObj
  params:
    refTaskId: register-configmap
    state:
      data:
        large_scale_completion_time: "{{now}}"
        large_scale_status: "completed"
    timeout: 5s

# Burst test - rapid submission of many jobs
- id: update-test-phase-burst
  type: UpdateObj
  params:
    refTaskId: register-configmap
    state:
      data:
        test_phase: "burst_test"
        start_time: "{{now}}"
    timeout: 5s

- id: clear-previous-jobs
  type: DeleteObj
  params:
    refTaskId: large-scale-test

- id: burst-test
  type: SubmitObj
  params:
    refTaskId: register-job
    count: 100
    params:
      namespace: perf-benchmark
      parallelism: 5
      completions: 5
      queueName: team-queue
      image: ubuntu
      cpu: 100m
      memory: 128Mi
      gpu: 1
      ttl: "30s"

- id: burst-test-wait
  type: CheckPod
  params:
    refTaskId: burst-test
    status: Running
    timeout: 10m

- id: update-burst-test-metrics
  type: UpdateObj
  params:
    refTaskId: register-configmap
    state:
      data:
        burst_test_completion_time: "{{now}}"
        burst_test_status: "completed"
    timeout: 5s

# Generate final report
- id: benchmark-summary
  type: UpdateObj
  params:
    refTaskId: register-configmap
    state:
      data:
        test_phase: "completed"
        completion_time: "{{now}}"
    timeout: 5s

- id: check-final-metrics
  type: CheckConfigmap
  params:
    name: benchmark-metrics
    namespace: perf-benchmark
    op: subset
    data:
      test_phase: "completed"