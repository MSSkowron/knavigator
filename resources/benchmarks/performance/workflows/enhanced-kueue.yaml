# Copyright (c) 2024, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: enhanced-kueue-benchmark
description: |
  A comprehensive performance benchmark for Kueue scheduler testing that:
  1. Collects baseline metrics before testing
  2. Performs incremental scaling tests to identify performance limits
  3. Measures key performance indicators like throughput and scheduling latency
  4. Tests resource utilization efficiency under varied conditions
tasks:
# Configure nodes & namespaces
- id: configure-nodes
  type: Configure
  params:
    nodes:
    - type: dgxa100.80g
      count: 700
      labels:
        nvidia.com/gpu.count: "8"
    timeout: 5m

# Register Kueue-specific resources
- id: register-cluster-queue
  type: RegisterObj
  params:
    template: "resources/templates/kueue/cluster-queue.yaml"
- id: register-local-queue
  type: RegisterObj
  params:
    template: "resources/templates/kueue/local-queue.yaml"
- id: register-resource-flavor
  type: RegisterObj
  params:
    template: "resources/templates/kueue/resource-flavor.yaml"
- id: register-job
  type: RegisterObj
  params:
    template: "resources/benchmarks/templates/kueue/job.yaml"
    nameFormat: "perftest-job{{._ENUM_}}"
    podNameFormat: "{{._NAME_}}-[0-9]-.*"
    podCount: "{{.parallelism}}"

# Create ResourceFlavor, ClusterQueue, LocalQueue
- id: create-resource-flavor
  type: SubmitObj
  params:
    refTaskId: register-resource-flavor
    canExist: true
    params:
      name: "gpu-node"
      nodeLabels:
        nvidia.com/gpu.count: "8"
- id: create-cluster-queue
  type: SubmitObj
  params:
    refTaskId: register-cluster-queue
    canExist: true
    params:
      name: team
      flavor: gpu-node
      cpu: 70000m
      memory: 700Gi
      pods: 700
      gpu: 5600
- id: create-local-queue
  type: SubmitObj
  params:
    refTaskId: register-local-queue
    canExist: true
    params:
      name: team-queue
      namespace: default
      clusterQueue: team

# Configure Kueue
- id: configure
  type: Configure
  params:
    configmaps:
    - name: kueue-manager-config
      namespace: kueue-system
      op: create
      data:
        controller_manager_config.yaml: |
          apiVersion: config.kueue.x-k8s.io/v1beta1
          kind: Configuration
          health:
            healthProbeBindAddress: :8081
          metrics:
            bindAddress: :8080
          # enableClusterQueueResources: true
          webhook:
            port: 9443
          leaderElection:
            leaderElect: true
            resourceName: c1f6bfd2.kueue.x-k8s.io
          controller:
            groupKindConcurrency:
              Job.batch: 5
              Pod: 5
              Workload.kueue.x-k8s.io: 5
              LocalQueue.kueue.x-k8s.io: 1
              ClusterQueue.kueue.x-k8s.io: 1
              ResourceFlavor.kueue.x-k8s.io: 1
          clientConnection:
            qps: 50
            burst: 100
          #pprofBindAddress: :8083
          waitForPodsReady:
            enable: true
            timeout: 5m
            blockAdmission: true
            requeuingStrategy:
              timestamp: Eviction
              backoffLimitCount: null # null indicates infinite requeuing
              backoffBaseSeconds: 60
              backoffMaxSeconds: 3600
          #manageJobsWithoutQueueName: true
          #internalCertManagement:
          #  enable: false
          #  webhookServiceName: ""
          #  webhookSecretName: ""
          integrations:
            frameworks:
            - "batch/job"
            - "kubeflow.org/mpijob"
            - "ray.io/rayjob"
            - "ray.io/raycluster"
            - "jobset.x-k8s.io/jobset"
            - "kubeflow.org/mxjob"
            - "kubeflow.org/paddlejob"
            - "kubeflow.org/pytorchjob"
            - "kubeflow.org/tfjob"
            - "kubeflow.org/xgboostjob"
          #  - "pod"
          #  externalFrameworks:
          #  - "Foo.v1.example.com"
            podOptions:
              namespaceSelector:
                matchExpressions:
                  - key: kubernetes.io/metadata.name
                    operator: NotIn
                    values: [ kube-system, kueue-system ]
          #fairSharing:
          #  enable: true
          #  preemptionStrategies: [LessThanOrEqualToFinalShare, LessThanInitialShare]
          #resources:
          #  excludeResourcePrefixes: []
    deploymentRestarts:
    - namespace: kueue-system
      name: kueue-controller-manager
    timeout: 10m

# Small scale test - 50 pods
- id: small-scale-test
  type: SubmitObj
  params:
    refTaskId: register-job
    count: 50
    params:
      namespace: default
      parallelism: 1
      completions: 1
      completionMode: NonIndexed
      queueName: team-queue
      image: ubuntu
      cpu: 100m
      memory: 128Mi
      gpu: 1
      ttl: "30s"

- id: wait
  type: Sleep
  params:
    # Required: Duration to wait
    timeout: 60s

- id: small-scale-wait
  type: CheckPod
  params:
    refTaskId: small-scale-test
    status: Running
    timeout: 2m

# Medium scale test - 200 pods
- id: medium-scale-test
  type: SubmitObj
  params:
    refTaskId: register-job
    count: 4
    params:
      namespace: default
      parallelism: 50
      completions: 50
      completionMode: NonIndexed
      queueName: team-queue
      image: ubuntu
      cpu: 100m
      memory: 128Mi
      gpu: 1
      ttl: "30s"

- id: medium-scale-wait
  type: CheckPod
  params:
    refTaskId: medium-scale-test
    status: Running
    timeout: 5m

# Large scale test - 700 pods
- id: large-scale-test
  type: SubmitObj
  params:
    refTaskId: register-job
    count: 1
    params:
      namespace: default
      parallelism: 700
      completions: 700
      completionMode: NonIndexed
      queueName: team-queue
      image: ubuntu
      cpu: 100m
      memory: 128Mi
      gpu: 1
      ttl: "60s"

- id: large-scale-wait
  type: CheckPod
  params:
    refTaskId: large-scale-test
    status: Running
    timeout: 10m

# Burst test - rapid submission of many jobs
- id: clear-previous-jobs
  type: DeleteObj
  params:
    refTaskId: large-scale-test

- id: burst-test
  type: SubmitObj
  params:
    refTaskId: register-job
    count: 100
    params:
      namespace: default
      parallelism: 5
      completions: 5
      completionMode: NonIndexed
      queueName: team-queue
      image: ubuntu
      cpu: 100m
      memory: 128Mi
      gpu: 1
      ttl: "30s"

- id: burst-test-wait
  type: CheckPod
  params:
    refTaskId: burst-test
    status: Running
    timeout: 10m