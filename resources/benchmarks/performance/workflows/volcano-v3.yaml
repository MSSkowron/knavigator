name: volcano-performance-benchmark-v3
description: |
  Performance benchmark for Volcano with diverse workloads.
  This tests the scheduler's ability to handle heterogeneous job types
  with different resource requirements simultaneously.
tasks:
  # Configure Volcano
  - id: configure-volcano
    type: Configure
    params:
      configmaps:
        - name: volcano-scheduler-configmap
          namespace: volcano-system
          op: create
          data:
            volcano-scheduler.conf: |
              actions: "enqueue, allocate, backfill"
              tiers:
              - plugins:
                - name: priority
                - name: gang
                - name: conformance
              - plugins:
                - name: drf
                - name: predicates
                - name: proportion
                - name: nodeorder
                - name: binpack
      deploymentRestarts:
        - namespace: volcano-system
          name: volcano-scheduler
      timeout: 10m

  # Configure nodes
  - id: configure-nodes
    type: Configure
    params:
      nodes:
        - type: hpc.gpu
          count: 700
          labels:
            nvidia.com/gpu.count: "8"
            nvidia.com/mlnxnics: "16"
            nvidia.com/gpu.product: NVIDIA-A100-SXM4-80GB
          resources:
            cpu: 128
            memory: "1Ti"
            pods: 110
            nvidia.com/gpu: 8
            nvidia.com/mlnxnics: 16
            hugepages-1Gi: 0
            hugepages-2Mi: 0
            ephemeral-storage: "30Ti"
      timeout: 5m

  # Register job templates for different types
  - id: register-high-gpu
    type: RegisterObj
    params:
      template: "resources/benchmarks/performance/templates/volcano/job.yaml"
      nameFormat: "high-gpu-job{{._ENUM_}}"
      podNameFormat: "{{._NAME_}}-test-[0-9]+"
      podCount: "{{.replicas}}"

  - id: register-medium-gpu
    type: RegisterObj
    params:
      template: "resources/benchmarks/performance/templates/volcano/job.yaml"
      nameFormat: "medium-gpu-job{{._ENUM_}}"
      podNameFormat: "{{._NAME_}}-test-[0-9]+"
      podCount: "{{.replicas}}"

  - id: register-cpu-only
    type: RegisterObj
    params:
      template: "resources/benchmarks/performance/templates/volcano/job.yaml"
      nameFormat: "cpu-job{{._ENUM_}}"
      podNameFormat: "{{._NAME_}}-test-[0-9]+"
      podCount: "{{.replicas}}"

  # Warmup phase - submit a few small jobs to initialize system
  - id: warmup-batch
    type: SubmitObj
    params:
      refTaskId: register-high-gpu
      count: 5
      params:
        namespace: default
        replicas: 1
        queue: default
        image: ubuntu
        cpu: 100m
        memory: 128M
        gpu: 1
        ttl: 5s

  # Short delay after warmup
  - id: warmup-delay
    type: Sleep
    params:
      timeout: 15s

  # Group 1: High-GPU Jobs (8 GPUs per job)
  # Total resources:
  # - 4,800 CPU cores (300 × 16 = 5.36% of cluster)
  # - ~28.1Ti memory (300 × 96Gi = 4.02% of cluster)
  # - 2,400 GPUs (300 × 8 = 42.86% of cluster)
  - id: high-gpu-jobs
    type: SubmitObj
    params:
      refTaskId: register-high-gpu
      count: 300
      params:
        namespace: default
        replicas: 1
        queue: default
        image: ubuntu
        cpu: 16000m # 16 cores (12.5% of node)
        memory: 96Gi # 96GB (9.4% of node)
        gpu: 8 # 8 GPUs (100% of node)
        ttl: 5m

  # Group 2: Medium-GPU Jobs (2 GPUs per job)
  # Total resources:
  # - 1,600 CPU cores (200 × 8 = 1.79% of cluster)
  # - ~6.25Ti memory (200 × 32Gi = 0.89% of cluster)
  # - 400 GPUs (200 × 2 = 7.14% of cluster)
  - id: medium-gpu-jobs
    type: SubmitObj
    params:
      refTaskId: register-medium-gpu
      count: 200
      params:
        namespace: default
        replicas: 1
        queue: default
        image: ubuntu
        cpu: 8000m # 8 cores (6.25% of node)
        memory: 32Gi # 32GB (3.1% of node)
        gpu: 2 # 2 GPUs (25% of node)
        ttl: 5m

  # Group 3: CPU-Only Jobs (no GPUs)
  # Total resources:
  # - 6,400 CPU cores (200 × 32 = 7.14% of cluster)
  # - ~25Ti memory (200 × 128Gi = 3.57% of cluster)
  # - 0 GPUs
  - id: cpu-only-jobs
    type: SubmitObj
    params:
      refTaskId: register-cpu-only
      count: 200
      params:
        namespace: default
        replicas: 1
        image: ubuntu
        cpu: 32000m # 32 cores (25% of node)
        memory: 128Gi # 128GB (12.5% of node)
        gpu: 0 # No GPUs
        ttl: 5m

  # Analysis phase - time to collect metrics
  - id: analysis-phase
    type: Sleep
    params:
      timeout: 60s
# Total cluster utilization:
# - 12,800 CPU cores (14.3% of cluster)
# - ~59.4Ti memory (8.5% of cluster)
# - 2,800 GPUs (50% of cluster)
